name: Remote SSH Command
on:
  push:
    branches:
      - develop
  workflow_dispatch: {}

jobs:
  deployment:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Execute remote SSH commands using password
        uses: appleboy/ssh-action@v1
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE_DEV: ${{ secrets.DB_DATABASE_DEV }}
        with:
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          username: ${{ secrets.USERNAME }}
          host: ${{ secrets.EC2_HOST}}
          port: ${{ secrets.EC2_PORT }}
          envs: DB_HOST,DB_PORT,DB_USERNAME,DB_PASSWORD,DB_DATABASE_DEV
          script: |
            cd ~/work/github/shuttler-backend-dev
            git pull
            export PGPASSWORD=${DB_PASSWORD}

            check_db_exists() {
              local dbname="$1"
              if psql -h ${DB_HOST} -p ${DB_PORT} -U ${DB_USERNAME} -d postgres -tAc "SELECT 1 FROM pg_database WHERE datname = '${dbname}';" | grep -q 1; then
                echo "è³‡æ–™åº« ${dbname} å·²å­˜åœ¨"
              else
                echo "è³‡æ–™åº« ${dbname} ä¸å­˜åœ¨"
              fi
            }
          
            echo "ğŸ” æª¢æŸ¥ç›®å‰ PM2 åŸ·è¡Œä¸­çš„æ‡‰ç”¨åˆ—è¡¨..."
            docker exec -i demo-backend-amd64 /pnpm/pm2 list

            echo "ğŸ›‘ åœæ­¢ PM2 ä¸­åç‚º api çš„æ‡‰ç”¨..."
            docker exec -i demo-backend-amd64 /pnpm/pm2 stop api

            echo "ğŸ—‘ï¸ åˆªé™¤ PM2 ä¸­åç‚º api çš„æ‡‰ç”¨..."
            docker exec -i demo-backend-amd64 /pnpm/pm2 delete api

            echo "ï¿½ é–‹å§‹æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹..."
            check_db_exists "${DB_DATABASE_DEV}"

            echo "ğŸ”¥ é–‹å§‹åˆªé™¤è³‡æ–™åº« ${DB_DATABASE_DEV}..."
            psql -h "${DB_HOST}" -p "${DB_PORT}" -U "${DB_USERNAME}" -d postgres -c "DROP DATABASE IF EXISTS \"${DB_DATABASE_DEV}\";"
            check_db_exists "${DB_DATABASE_DEV}"

            echo "ğŸ› ï¸ é–‹å§‹å»ºç«‹è³‡æ–™åº« ${DB_DATABASE_DEV}..."
            psql -h "${DB_HOST}" -p "${DB_PORT}" -U "${DB_USERNAME}" -d postgres -c "CREATE DATABASE \"${DB_DATABASE_DEV}\" WITH OWNER \"${DB_USERNAME}\" TEMPLATE template0 ENCODING 'UTF8';"
            check_db_exists "${DB_DATABASE_DEV}"

            echo "ğŸ“¦ é–‹å§‹å®‰è£ PNPM ç›¸ä¾å¥—ä»¶..."
            docker exec -i demo-backend-amd64 /usr/local/bin/pnpm install
            echo "âœ… PNPM ç›¸ä¾å¥—ä»¶å®‰è£å®Œæˆã€‚"

            echo "ğŸŒ± é–‹å§‹åŸ·è¡Œè³‡æ–™åº«ç¨®å­è³‡æ–™ï¼ˆseedï¼‰åˆå§‹åŒ–..."
            docker exec -i demo-backend-amd64 npm run seed
            echo "âœ… è³‡æ–™åº«ç¨®å­è³‡æ–™å·²æˆåŠŸåŸ·è¡Œå®Œæˆã€‚"

            echo "ğŸŸ¢ å•Ÿå‹• PM2 ä¸­åç‚º api çš„æ‡‰ç”¨..."
            docker exec -i demo-backend-amd64 /pnpm/pm2 start ./bin/www.js --name api
            echo "ğŸš€ Deploy complete"